<!DOCTYPE html>
<html>
  <head>
    <script type='text/javascript' src='https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js'></script>
    <script type='text/javascript' src='jquery.ba-hashchange.min.js'></script>
    <script type='text/javascript' src='jquery.swiftype.search.js'></script>
    <link type='text/css' rel='stylesheet' href='search.css' media='all' />
    
    <div class="st-dynamic-facets">
    </div>

    <script type='text/javascript'>
    var customRenderFunction = function(document_type, item) {
    var out = '<a href="' + item['url'] + '" class="st-search-result-link">' + item['title'] + '</a>';
    return out; 
    };

    var searchConfig = {
        facets: {}
    };

    var readFilters = function() {
        return {
'page': {color: window.searchConfig.facets['color']}
        }
    }

    var reloadResults = function() {
        $(window).hashchange();
    };

    var $facetContainer = $('.st-dynamic-facets');

      $(function() {
        $('#st-search-input').swiftypeSearch({
          resultContainingElement: '#st-results-container',
          fetchFields: {"page": ['color', 'title', 'url']},
          facets: { 'page': ['color'] },
          postRenderFunction: bindControls,
          filters: readFilters,
          engineKey: 'VMnz-Ws16PuL8HyLPciN'
        });
      });

    var bindControls = function(data) {
  var resultInfo = data['info'],
  facets = '';

  $.each(resultInfo, function(documentType, typeInfo){
    $.each(typeInfo.facets, function(field, facetCounts) {
      facets += ['<div class="facet"><h3>', field, '</h3></div>'].join('')
      $.each(facetCounts, function(label, count) {
        var status = "",
        id = encodeURIComponent(label).toLowerCase();
        if (window.searchConfig.facets[field]){ 
            console.log("index: ", window.searchConfig.facets[field].indexOf(label));
        }
        if (window.searchConfig.facets[field] && window.searchConfig.facets[field].indexOf(label) > -1) {
          status = ' checked="checked"'
        }

        facets += '<input type="checkbox"' + status + ' name="' + field + '" value="' + label + '" id="' + id + '"> <label for="' + id + '">' + label + ' (' + count + ')</label><br/>';
      });
      facets += '<a href="#" class="clear-selection" data-name="' + field + '">Clear all</a>'
    });
    $facetContainer.html(facets);
  });
    };

    $facetContainer.on('click', 'input', function(e) {
        window.searchConfig.facets = {}; // Set the hash to empty
        $('.st-dynamic-facets input[type="checkbox"]').each(function(idx, obj) {
            var $checkbox = $(obj),
            facet = $checkbox.attr('name');
            //console.log(facet);
            if(!window.searchConfig.facets[facet]) { // if facets are null or undefined, put empty array for the category
              window.searchConfig.facets[facet] = [];
              console.log("burp");
            }
            //console.log($checkbox.attr('value'), $checkbox.attr('checked'));
            if($checkbox.is(':checked')) { // add ids to array for the category
                window.searchConfig.facets[facet].push($checkbox.attr('value'));
                console.log('poopy');
            }
        })

    reloadResults();
});

    $facetContainer.on('click', 'a.clear-selection', function(e) {
        e.preventDefault();
        var name = $(this).data('name');
        $('input[name=' + name + ']').attr('checked', false);
        window.searchConfig.facets[name] = [];

        reloadResults();
    });


    </script>
  </head>
  <body>
    <h1>Example Swiftype Search installation</h1>

    <p>
      This example shows the default behavior of the Swiftype search plugin using the data created in the <a href="https://github.com/swiftype/swiftype-api-example">swiftype-api-example</a> (also, check out our <a href="https://swiftype.com/documentation/tutorials/schema_design">tutorial about the example</a>).
    </p>

    <p>
      Try searches for "cat", "psy", or "glass".
    </p>

    <form>
      Search your site: <input type='text' id='st-search-input' class='st-search-input' />
    </form>
    

    <div id="st-results-container" class="st-result-listing"></div>
  </body>
</html>
